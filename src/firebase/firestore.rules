rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function memberRole(committeeId, uid) {
      return exists(/databases/$(database)/documents/committees/$(committeeId)/members/$(uid))
        ? get(/databases/$(database)/documents/committees/$(committeeId)/members/$(uid)).data.role
        : "";
    }

    function isOwner(committeeId, uid) {
      return memberRole(committeeId, uid) == 'owner';
    }

    function isMember(committeeId, uid) {
      return exists(/databases/$(database)/documents/committees/$(committeeId)/members/$(uid));
    }

    match /users/{userId} {
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow read: if isSignedIn();
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }

    match /committees/{committeeId} {
      // Create: authenticated user creating a committee they own
      allow create: if isSignedIn()
        && request.resource.data.ownerUid == request.auth.uid;

      // Read (get/list): only for members of that committee
      allow get, list: if isSignedIn()
        && isMember(committeeId, request.auth.uid);

      // Update: owner or chair may update allowed committee fields
      allow update: if isSignedIn()
        && (memberRole(committeeId, request.auth.uid) in ['owner', 'chair'])
        && request.resource.data.diff(resource.data)
             .affectedKeys()
             .hasOnly([
               'name',
               'description',
               'settings',
               'inviteCode'
             ]);

      // Delete: only owner may delete a committee
      allow delete: if isSignedIn() && isOwner(committeeId, request.auth.uid);

      match /members/{memberId} {
        // Members list readable by members
        allow read: if isSignedIn()
          && isMember(committeeId, request.auth.uid);

        // Create membership:
        // - a user may create their own member doc (self-join) but only as 'member'
        // - the owner may create any membership and assign 'chair' or 'member'
        allow create: if isSignedIn() && (
          (request.auth.uid == memberId
            && request.resource.data.uid == memberId
            && (request.resource.data.role == 'member' || !(request.resource.data.keys().hasAny(['role'])))
          )
          || isOwner(committeeId, request.auth.uid)
        );

        // Update membership:
        // - owner may update any member's role except assigning 'owner'
        // - a member may update their own profile but must not change their role
        allow update: if isSignedIn() && (
          (isOwner(committeeId, request.auth.uid)
            && !(request.resource.data.role == 'owner')
          )
          || (request.auth.uid == memberId && request.resource.data.role == resource.data.role)
        );

        // Delete membership: member may remove themself, owner may remove any member
        allow delete: if isSignedIn() && (
          request.auth.uid == memberId || isOwner(committeeId, request.auth.uid)
        );
      }

      match /motions/{motionId} {
        // Members can read motions
        allow read: if isSignedIn()
          && isMember(committeeId, request.auth.uid);

        // Members can create motions; creatorUid must match
        allow create: if isSignedIn()
          && isMember(committeeId, request.auth.uid)
          && request.resource.data.creatorUid == request.auth.uid;

        // Only owner/chair can update/delete motions
        allow update, delete: if isSignedIn()
          && (memberRole(committeeId, request.auth.uid) in ['owner', 'chair']);

        match /replies/{replyId} {
          allow create: if isSignedIn()
            && isMember(committeeId, request.auth.uid)
            && request.resource.data.authorUid == request.auth.uid;

          allow read: if isSignedIn()
            && isMember(committeeId, request.auth.uid);

          allow delete: if isSignedIn()
            && (memberRole(committeeId, request.auth.uid) in ['owner', 'chair']);
        }

        match /votes/{voteId} {
          // Members can cast votes; voterUid must match auth uid
          allow create: if isSignedIn()
            && isMember(committeeId, request.auth.uid)
            && request.resource.data.voterUid == request.auth.uid;

          // Votes read:
          // - non-anonymous votes readable by members
          // - anonymous votes only visible to chair/owner
          allow read: if isSignedIn()
            && isMember(committeeId, request.auth.uid)
            && (
              !resource.data.anonymous
              || (memberRole(committeeId, request.auth.uid) in ['owner', 'chair'])
            );

          allow delete: if isSignedIn()
            && (memberRole(committeeId, request.auth.uid) in ['owner', 'chair']);
        }
      }

      match /decisions/{decisionId} {
        allow read: if isSignedIn()
          && isMember(committeeId, request.auth.uid);

        allow create, update, delete: if isSignedIn()
          && (memberRole(committeeId, request.auth.uid) in ['owner', 'chair']);
      }
    }
  }
}