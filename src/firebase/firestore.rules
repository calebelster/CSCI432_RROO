/*
Rules implement:
- users: owner-only updates
- committees and nested collections: members control
*/
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function memberRole(committeeId, uid) {
      return exists(/databases/$(database)/documents/committees/$(committeeId)/members/$(uid)) ?
             get(/databases/$(database)/documents/committees/$(committeeId)/members/$(uid)).data.role : "";
    }
    function isMember(committeeId, uid) {
      return exists(/databases/$(database)/documents/committees/$(committeeId)/members/$(uid));
    }

    match /users/{userId} {
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow read: if isSignedIn();
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }

    match /committees/{committeeId} {
      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;
      // read only for members
      allow get, list: if isSignedIn() && isMember(committeeId, request.auth.uid);
      // update settings only by owner or chair
      allow update, delete: if isSignedIn() && (memberRole(committeeId, request.auth.uid) in ['owner', 'chair']);

      match /members/{memberId} {
        // members list readable by members
        allow read: if isSignedIn() && isMember(committeeId, request.auth.uid);
        // add or change membership by owner or chair; user can remove themself
        allow create, update, delete: if isSignedIn() &&
            (memberRole(committeeId, request.auth.uid) in ['owner','chair'] || request.auth.uid == memberId);
      }

      match /motions/{motionId} {
        allow read: if isSignedIn() && isMember(committeeId, request.auth.uid);
        // members can create motions; creatorUid must match
        allow create: if isSignedIn() && isMember(committeeId, request.auth.uid) &&
                      request.resource.data.creatorUid == request.auth.uid;
        // only owner/chair can update status or settings of a motion
        allow update, delete: if isSignedIn() && (memberRole(committeeId, request.auth.uid) in ['owner','chair']);

        match /replies/{replyId} {
          allow create: if isSignedIn() && isMember(committeeId, request.auth.uid) &&
                        request.resource.data.authorUid == request.auth.uid;
          allow read: if isSignedIn() && isMember(committeeId, request.auth.uid);
          allow delete: if isSignedIn() && (memberRole(committeeId, request.auth.uid) in ['owner','chair']);
        }

        match /votes/{voteId} {
          allow create: if isSignedIn() && isMember(committeeId, request.auth.uid) &&
                        // ensure client sets voterUid to themselves
                        request.resource.data.voterUid == request.auth.uid;
          // votes read: non-anonymous votes readable by members; anonymous votes only visible to chair/owner
          allow read: if isSignedIn() &&
            ( !resource.data.anonymous || (memberRole(committeeId, request.auth.uid) in ['owner','chair']) ) &&
            isMember(committeeId, request.auth.uid);
          allow delete: if isSignedIn() && (memberRole(committeeId, request.auth.uid) in ['owner','chair']);
        }
      }

      match /decisions/{decisionId} {
        allow read: if isSignedIn() && isMember(committeeId, request.auth.uid);
        allow create, update, delete: if isSignedIn() && (memberRole(committeeId, request.auth.uid) in ['owner','chair']);
      }
    }
  }
}